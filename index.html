<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vehicle Acceleration Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e14;
            --bg-panel: #151921;
            --border-color: #2d3748;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 16px;
            min-height: 100vh;
            -webkit-user-select: none;
            user-select: none;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .header p {
            font-size: 11px;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .status-bar {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .control-panel {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            background: var(--bg-panel);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 14px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn.primary {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-dark);
        }

        .btn.primary.recording {
            background: var(--accent-red);
            border-color: var(--accent-red);
            animation: pulse-btn 1.5s infinite;
        }

        @keyframes pulse-btn {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .btn.secondary {
            background: var(--bg-panel);
            border-color: var(--accent-blue);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .metrics-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 16px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-label {
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .metric-band {
            font-size: 10px;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .metric-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .metric-item {
            text-align: center;
        }

        .metric-item-label {
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            font-family: monospace;
            line-height: 1;
        }

        .metric-value.positive {
            color: var(--accent-green);
        }

        .metric-value.negative {
            color: var(--accent-red);
        }

        .metric-value.total {
            color: var(--accent-blue);
        }

        .metric-unit {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .balance-bar {
            margin-top: 12px;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .balance-fill {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-red));
            transition: width 0.3s ease;
        }

        .total-energy {
            background: linear-gradient(135deg, var(--bg-panel), #1a1f2e);
            border: 2px solid var(--accent-blue);
            border-radius: 4px;
            padding: 20px;
            text-align: center;
        }

        .total-energy-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .total-energy-value {
            font-size: 48px;
            font-weight: bold;
            color: var(--accent-blue);
            font-family: monospace;
        }

        .sample-rate {
            text-align: center;
            margin-top: 16px;
            font-size: 10px;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--accent-yellow);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 11px;
            color: var(--accent-yellow);
            text-align: center;
        }

        .recording-time {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-red);
            margin: 12px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>V.A.A.</h1>
        <p>Vehicle Acceleration Analyzer</p>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">STANDBY</span>
        </div>
        <div style="font-size: 11px; color: var(--text-secondary);">
            <span id="sampleCount">0</span> SAMPLES
        </div>
    </div>

    <div class="control-panel">
        <button class="btn primary" id="startBtn" onclick="toggleRecording()">START MONITORING</button>
        <button class="btn secondary" id="resetBtn" onclick="resetMetrics()" disabled>RESET DATA</button>
        <button class="btn secondary" id="saveBtn" onclick="saveResults()" disabled>SAVE RESULTS</button>
        <button class="btn secondary" id="configBtn" onclick="toggleConfig()">CONFIGURATION</button>
    </div>

    <div id="configPanel" class="metric-card" style="display: none; margin-bottom: 16px;">
        <div class="metric-header">
            <span class="metric-label">Configuration</span>
        </div>
        <div style="padding: 8px 0;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">GRAVITY OFFSET (m/s²)</label>
                <input type="number" id="gravityOffset" value="9.8" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">FILTER ORDER</label>
                <input type="number" id="filterOrder" value="4" min="2" max="8" step="2" style="width: 100%; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace;">
            </div>
            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 11px; font-weight: bold; color: var(--text-secondary); margin-bottom: 8px;">BAND 1 (Primary) - Hz</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <label style="font-size: 10px; color: var(--text-secondary);">LOW</label>
                        <input type="number" id="band1Low" value="0.5" step="0.1" style="width: 100%; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: var(--text-secondary);">HIGH</label>
                        <input type="number" id="band1High" value="3.5" step="0.1" style="width: 100%; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 11px; font-weight: bold; color: var(--text-secondary); margin-bottom: 8px;">BAND 2 (Chop) - Hz</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <label style="font-size: 10px; color: var(--text-secondary);">LOW</label>
                        <input type="number" id="band2Low" value="3.5" step="0.1" style="width: 100%; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: var(--text-secondary);">HIGH</label>
                        <input type="number" id="band2High" value="9.0" step="0.1" style="width: 100%; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-size: 11px; font-weight: bold; color: var(--text-secondary); margin-bottom: 8px;">BAND 3 (Secondary) - Hz</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <label style="font-size: 10px; color: var(--text-secondary);">LOW</label>
                        <input type="number" id="band3Low" value="9.0" step="0.1" style="width: 100%; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: var(--text-secondary);">HIGH</label>
                        <input type="number" id="band3High" value="15.0" step="0.1" style="width: 100%; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    </div>
                </div>
            </div>
            <button class="btn primary" onclick="applyConfig()" style="width: 100%; margin-top: 8px;">APPLY CONFIGURATION</button>
        </div>
    </div>

    <div id="recordingTime" class="recording-time" style="display: none;">00:00</div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Primary</span>
                <span class="metric-band">0.5-3.5 Hz</span>
            </div>
            <div class="metric-values">
                <div class="metric-item">
                    <div class="metric-item-label">UPWARD</div>
                    <div class="metric-value positive" id="band1Pos">0.00<span class="metric-unit">g</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-item-label">DOWNWARD</div>
                    <div class="metric-value negative" id="band1Neg">0.00<span class="metric-unit">g</span></div>
                </div>
            </div>
            <div class="balance-bar">
                <div class="balance-fill" id="band1Bar" style="width: 50%"></div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Chop</span>
                <span class="metric-band">3.5-9 Hz</span>
            </div>
            <div class="metric-values">
                <div class="metric-item">
                    <div class="metric-item-label">UPWARD</div>
                    <div class="metric-value positive" id="band2Pos">0.00<span class="metric-unit">g</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-item-label">DOWNWARD</div>
                    <div class="metric-value negative" id="band2Neg">0.00<span class="metric-unit">g</span></div>
                </div>
            </div>
            <div class="balance-bar">
                <div class="balance-fill" id="band2Bar" style="width: 50%"></div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Secondary</span>
                <span class="metric-band">9-15 Hz</span>
            </div>
            <div class="metric-values">
                <div class="metric-item">
                    <div class="metric-item-label">UPWARD</div>
                    <div class="metric-value positive" id="band3Pos">0.00<span class="metric-unit">g</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-item-label">DOWNWARD</div>
                    <div class="metric-value negative" id="band3Neg">0.00<span class="metric-unit">g</span></div>
                </div>
            </div>
            <div class="balance-bar">
                <div class="balance-fill" id="band3Bar" style="width: 50%"></div>
            </div>
        </div>
    </div>

    <div class="total-energy">
        <div class="total-energy-label">Total RMS Energy</div>
        <div class="total-energy-value" id="totalRMS">0.000<span class="metric-unit">g</span></div>
    </div>

    <div class="sample-rate">
        SAMPLE RATE: <span id="sampleRate">0</span> Hz | ORIENTATION: Z-AXIS VERTICAL
    </div>

    <div class="metric-card" style="margin-top: 16px; background: rgba(239, 68, 68, 0.1); border-color: var(--accent-red);">
        <div class="metric-header">
            <span class="metric-label">DEBUG INFO</span>
        </div>
        <div style="font-size: 10px; color: var(--text-secondary); line-height: 1.6;">
            <div style="color: var(--accent-yellow); margin-bottom: 8px;"><strong>⚠ WAKE SENSORS:</strong> Shake/tilt phone before starting!</div>
            <div><strong>Sensor Support:</strong> <span id="debugSupport">Checking...</span></div>
            <div><strong>Permission Status:</strong> <span id="debugPermission">Not requested</span></div>
            <div><strong>Events Received:</strong> <span id="debugEvents">0</span></div>
            <div><strong>Last Z Reading:</strong> <span id="debugZ">--</span></div>
            <div><strong>Last Update:</strong> <span id="debugTime">--</span></div>
            <div><strong>Error Log:</strong> <span id="debugError">None</span></div>
        </div>
    </div>

    <script>
        // Global state
        let isRecording = false;
        let accelerometerData = [];
        let sampleRate = 100; // Target 100 Hz
        let lastTimestamp = 0;
        let actualSampleRate = 0;
        let sensorHandle = null;
        let startTime = 0;
        let recordingInterval = null;
        let eventCount = 0;
        let lastZValue = null;

        // Configuration parameters
        let config = {
            gravityOffset: 9.8,
            filterOrder: 4,
            bands: [
                { name: 'band1', low: 0.5, high: 3.5, label: 'Primary' },
                { name: 'band2', low: 3.5, high: 9.0, label: 'Chop' },
                { name: 'band3', low: 9.0, high: 15.0, label: 'Secondary' }
            ]
        };

        // Frequency bands configuration (will be updated from config)
        let bands = [...config.bands];

        // Butterworth bandpass filter coefficients (2nd order)
        function designButterworthBandpass(lowFreq, highFreq, sampleRate) {
            const nyquist = sampleRate / 2;
            const low = lowFreq / nyquist;
            const high = highFreq / nyquist;
            
            // Simplified filter coefficients for real-time processing
            return {
                low: low,
                high: high,
                // Using simple moving average approximation for efficiency
                taps: Math.max(3, Math.floor(sampleRate / ((lowFreq + highFreq) / 2)))
            };
        }

        // Apply bandpass filter to data
        // Butterworth bandpass filter using cascaded biquad sections
        function bandpassFilter(data, lowFreq, highFreq, sampleRate) {
            if (data.length < 10) return data;
            
            const order = config.filterOrder;
            
            // High-pass stage (removes frequencies below lowFreq)
            const alphaHP = Math.exp(-2 * Math.PI * lowFreq / sampleRate);
            let highPassed = new Array(data.length);
            highPassed[0] = data[0];
            
            for (let i = 1; i < data.length; i++) {
                highPassed[i] = alphaHP * (highPassed[i-1] + data[i] - data[i-1]);
            }
            
            // Apply high-pass multiple times for higher order
            for (let pass = 1; pass < order / 2; pass++) {
                for (let i = 1; i < highPassed.length; i++) {
                    highPassed[i] = alphaHP * (highPassed[i-1] + highPassed[i] - highPassed[i-1]);
                }
            }
            
            // Low-pass stage (removes frequencies above highFreq)
            const alphaLP = Math.exp(-2 * Math.PI * highFreq / sampleRate);
            let bandPassed = new Array(highPassed.length);
            bandPassed[0] = highPassed[0];
            
            for (let i = 1; i < highPassed.length; i++) {
                bandPassed[i] = (1 - alphaLP) * highPassed[i] + alphaLP * bandPassed[i-1];
            }
            
            // Apply low-pass multiple times for higher order
            for (let pass = 1; pass < order / 2; pass++) {
                for (let i = 1; i < bandPassed.length; i++) {
                    bandPassed[i] = (1 - alphaLP) * bandPassed[i] + alphaLP * bandPassed[i-1];
                }
            }
            
            return bandPassed;
        }

        // Calculate RMS in time domain: filter first, then separate positive/negative, then compute RMS
        function calculateRMSTimedom(filteredData) {
            if (filteredData.length === 0) return { positive: 0, negative: 0, total: 0, rawPositive: [], rawNegative: [] };

            // Separate positive and negative values from filtered signal
            const positiveValues = [];
            const negativeValues = [];
            
            for (let i = 0; i < filteredData.length; i++) {
                if (filteredData[i] > 0) {
                    positiveValues.push(filteredData[i]);
                } else if (filteredData[i] < 0) {
                    negativeValues.push(filteredData[i]);
                }
            }

            // Calculate RMS for positive values (time domain)
            const rmsPos = positiveValues.length > 0 ? 
                Math.sqrt(positiveValues.reduce((sum, v) => sum + v * v, 0) / positiveValues.length) : 0;
            
            // Calculate RMS for negative values (time domain)
            const rmsNeg = negativeValues.length > 0 ? 
                Math.sqrt(negativeValues.reduce((sum, v) => sum + v * v, 0) / negativeValues.length) : 0;

            // Calculate total RMS (time domain)
            const rmsTotal = filteredData.length > 0 ? 
                Math.sqrt(filteredData.reduce((sum, v) => sum + v * v, 0) / filteredData.length) : 0;

            return {
                positive: rmsPos,
                negative: rmsNeg,
                total: rmsTotal,
                rawPositive: positiveValues,
                rawNegative: negativeValues
            };
        }

        // Update display
        function updateDisplay() {
            if (accelerometerData.length < 20) return; // Need minimum samples

            // Extract Z-axis acceleration values (in m/s²)
            const zData = accelerometerData.map(d => d.z);
            
            // Remove gravity component using tunable offset
            const gravityOffsetValue = config.gravityOffset;
            const zDataNoGravity = zData.map(v => v - gravityOffsetValue);

            let totalRMS = 0;
            let totalSamples = 0;

            // Process each frequency band with new order of operations:
            // 1. Filter the signal
            // 2. Separate positive and negative from filtered signal
            // 3. Calculate RMS for each in time domain
            bands.forEach(band => {
                const filtered = bandpassFilter(zDataNoGravity, band.low, band.high, actualSampleRate);
                const rms = calculateRMSTimedom(filtered);

                // Update display
                document.getElementById(`${band.name}Pos`).innerHTML = 
                    `${rms.positive.toFixed(3)}<span class="metric-unit">g</span>`;
                document.getElementById(`${band.name}Neg`).innerHTML = 
                    `${rms.negative.toFixed(3)}<span class="metric-unit">g</span>`;

                // Update balance bar
                const total = rms.positive + rms.negative;
                const percentage = total > 0 ? (rms.positive / total * 100) : 50;
                document.getElementById(`${band.name}Bar`).style.width = `${percentage}%`;

                // Accumulate for total RMS
                totalRMS += rms.total * rms.total;
                totalSamples++;
            });

            // Calculate and display total RMS
            const overallRMS = Math.sqrt(totalRMS / totalSamples);
            document.getElementById('totalRMS').innerHTML = 
                `${overallRMS.toFixed(3)}<span class="metric-unit">g</span>`;

            // Update sample count
            document.getElementById('sampleCount').textContent = accelerometerData.length;
        }

        // Start/Stop recording
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                document.getElementById('debugError').textContent = 'None';
                document.getElementById('debugPermission').textContent = 'Requesting...';

                // Request permission for device motion
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('debugPermission').textContent = 'iOS - requesting permission...';
                    const permission = await DeviceMotionEvent.requestPermission();
                    document.getElementById('debugPermission').textContent = `iOS - ${permission}`;
                    if (permission !== 'granted') {
                        alert('Permission to access motion sensors was denied.');
                        return;
                    }
                } else {
                    document.getElementById('debugPermission').textContent = 'Android - no permission needed';
                }

                isRecording = true;
                accelerometerData = [];
                lastTimestamp = 0;
                startTime = Date.now();
                eventCount = 0;

                // Update UI
                document.getElementById('startBtn').textContent = 'STOP MONITORING';
                document.getElementById('startBtn').classList.add('recording');
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('statusDot').classList.add('active');
                document.getElementById('statusText').textContent = 'RECORDING';
                document.getElementById('recordingTime').style.display = 'block';

                // Start recording timer
                recordingInterval = setInterval(updateRecordingTime, 100);

                // Start listening to accelerometer
                window.addEventListener('devicemotion', handleMotion);
                document.getElementById('debugPermission').textContent = 'Event listener added';

                // Estimate sample rate
                setTimeout(() => {
                    if (accelerometerData.length > 10) {
                        const duration = (accelerometerData[accelerometerData.length - 1].time - 
                                        accelerometerData[0].time) / 1000;
                        actualSampleRate = accelerometerData.length / duration;
                        document.getElementById('sampleRate').textContent = Math.round(actualSampleRate);
                    } else {
                        document.getElementById('debugError').textContent = `Only ${accelerometerData.length} samples after 2s`;
                    }
                }, 2000);

            } catch (error) {
                document.getElementById('debugError').textContent = error.message;
                alert('Error accessing accelerometer: ' + error.message);
                isRecording = false;
            }
        }

        // Stop recording
        function stopRecording() {
            isRecording = false;
            window.removeEventListener('devicemotion', handleMotion);
            clearInterval(recordingInterval);

            // Update UI
            document.getElementById('startBtn').textContent = 'START MONITORING';
            document.getElementById('startBtn').classList.remove('recording');
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('statusText').textContent = 'STANDBY';
            document.getElementById('recordingTime').style.display = 'none';
        }

        // Handle motion event
        function handleMotion(event) {
            eventCount++;
            document.getElementById('debugEvents').textContent = eventCount;
            
            if (!isRecording) return;

            // Try multiple acceleration sources
            let acc = event.accelerationIncludingGravity;
            
            // Debug: Check what data is available
            if (!acc || acc.z === null) {
                acc = event.acceleration;
                if (acc && acc.z !== null) {
                    document.getElementById('debugError').textContent = 'Using acceleration (no gravity)';
                } else {
                    document.getElementById('debugError').textContent = 'No acceleration data available';
                    return;
                }
            }

            if (acc && acc.z !== null) {
                const now = Date.now();
                lastZValue = acc.z;
                
                document.getElementById('debugZ').textContent = acc.z.toFixed(3) + ' m/s²';
                document.getElementById('debugTime').textContent = new Date().toLocaleTimeString();
                
                accelerometerData.push({
                    time: now,
                    z: acc.z
                });

                // Update display every 100ms
                if (now - lastTimestamp > 100) {
                    lastTimestamp = now;
                    updateDisplay();
                }
            } else {
                document.getElementById('debugError').textContent = 'acc.z is null';
            }
        }

        // Update recording time display
        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTime').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Reset metrics
        function resetMetrics() {
            accelerometerData = [];
            
            // Reset all displays
            ['band1', 'band2', 'band3'].forEach(band => {
                document.getElementById(`${band}Pos`).innerHTML = '0.00<span class="metric-unit">g</span>';
                document.getElementById(`${band}Neg`).innerHTML = '0.00<span class="metric-unit">g</span>';
                document.getElementById(`${band}Bar`).style.width = '50%';
            });
            
            document.getElementById('totalRMS').innerHTML = '0.000<span class="metric-unit">g</span>';
            document.getElementById('sampleCount').textContent = '0';
            document.getElementById('saveBtn').disabled = true;
        }

        // Save results
        function saveResults() {
            if (accelerometerData.length === 0) {
                alert('No data to save!');
                return;
            }

            // Prompt for filename
            const defaultName = 'vehicle-test-' + new Date().toISOString().slice(0,19).replace(/:/g,'-');
            const filename = prompt('Enter filename:', defaultName);
            
            if (!filename) return; // User cancelled

            // Calculate final results
            const zData = accelerometerData.map(d => d.z);
            const gravityOffsetValue = config.gravityOffset;
            const zDataNoGravity = zData.map(v => v - gravityOffsetValue);

            const duration = (accelerometerData[accelerometerData.length - 1].time - 
                            accelerometerData[0].time) / 1000;

            // Compile results
            let results = {
                filename: filename,
                timestamp: new Date().toISOString(),
                duration_seconds: duration.toFixed(2),
                sample_count: accelerometerData.length,
                sample_rate_hz: (accelerometerData.length / duration).toFixed(1),
                gravity_offset_ms2: gravityOffsetValue.toFixed(2),
                filter_order: config.filterOrder,
                bands: {}
            };

            // Process each band
            bands.forEach(band => {
                const filtered = bandpassFilter(zDataNoGravity, band.low, band.high, actualSampleRate);
                const rms = calculateRMSTimedom(filtered);
                
                results.bands[`${band.low}-${band.high}Hz`] = {
                    upward_rms_g: rms.positive.toFixed(4),
                    downward_rms_g: rms.negative.toFixed(4),
                    total_rms_g: rms.total.toFixed(4),
                    balance_percent: ((rms.positive / (rms.positive + rms.negative) * 100) || 50).toFixed(1)
                };
            });

            // Calculate overall RMS
            let totalRMS = 0;
            bands.forEach(band => {
                const filtered = bandpassFilter(zDataNoGravity, band.low, band.high, actualSampleRate);
                const rms = calculateRMSTimedom(filtered);
                totalRMS += rms.total * rms.total;
            });
            results.overall_rms_g = Math.sqrt(totalRMS / bands.length).toFixed(4);

            // Create downloadable file
            const jsonStr = JSON.stringify(results, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('Results saved as ' + filename + '.json');
        }

        // Toggle configuration panel
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Apply configuration
        function applyConfig() {
            // Update config from input fields
            config.gravityOffset = parseFloat(document.getElementById('gravityOffset').value);
            config.filterOrder = parseInt(document.getElementById('filterOrder').value);
            
            // Update band configurations
            config.bands[0].low = parseFloat(document.getElementById('band1Low').value);
            config.bands[0].high = parseFloat(document.getElementById('band1High').value);
            config.bands[1].low = parseFloat(document.getElementById('band2Low').value);
            config.bands[1].high = parseFloat(document.getElementById('band2High').value);
            config.bands[2].low = parseFloat(document.getElementById('band3Low').value);
            config.bands[2].high = parseFloat(document.getElementById('band3High').value);
            
            // Update bands array
            bands = [...config.bands];
            
            // Update band labels in UI
            document.querySelectorAll('.metric-band').forEach((elem, idx) => {
                elem.textContent = `${bands[idx].low}-${bands[idx].high} Hz`;
            });
            
            // Hide config panel
            toggleConfig();
            
            alert('Configuration applied! Changes will take effect on next recording.');
        }

        // Check for accelerometer support on load
        window.addEventListener('load', () => {
            if (window.DeviceMotionEvent) {
                document.getElementById('debugSupport').textContent = 'DeviceMotionEvent supported ✓';
                document.getElementById('debugSupport').style.color = 'var(--accent-green)';
                
                // Test if we can get any motion data (passive listener)
                let testCount = 0;
                const testListener = (event) => {
                    testCount++;
                    document.getElementById('debugEvents').textContent = testCount + ' (test mode)';
                    
                    // Check all possible data sources
                    let debugInfo = [];
                    
                    if (event.accelerationIncludingGravity) {
                        const acc = event.accelerationIncludingGravity;
                        debugInfo.push(`withGrav: x=${acc.x} y=${acc.y} z=${acc.z}`);
                    } else {
                        debugInfo.push('withGrav: null');
                    }
                    
                    if (event.acceleration) {
                        const acc = event.acceleration;
                        debugInfo.push(`noGrav: x=${acc.x} y=${acc.y} z=${acc.z}`);
                    } else {
                        debugInfo.push('noGrav: null');
                    }
                    
                    if (event.rotationRate) {
                        debugInfo.push('rotationRate: present');
                    }
                    
                    document.getElementById('debugZ').textContent = debugInfo.join(' | ');
                    document.getElementById('debugError').textContent = `Interval: ${event.interval}ms`;
                };
                
                window.addEventListener('devicemotion', testListener);
                
                // Remove test listener after 5 seconds
                setTimeout(() => {
                    window.removeEventListener('devicemotion', testListener);
                    if (testCount === 0) {
                        document.getElementById('debugError').textContent = 'No motion events received in 5s';
                    } else if (testCount === 1) {
                        document.getElementById('debugPermission').textContent = `Only 1 event - sensors might be sleeping`;
                    } else {
                        document.getElementById('debugPermission').textContent = `Test OK - ${testCount} events`;
                    }
                }, 5000);
                
            } else {
                document.getElementById('debugSupport').textContent = 'DeviceMotionEvent NOT supported ✗';
                document.getElementById('debugSupport').style.color = 'var(--accent-red)';
                alert('This device does not support motion sensors. Please use a smartphone.');
            }
        });
    </script>
</body>
</html>
